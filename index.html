<!DOCTYPE html>
<html>
<head>
    <title>Math Game with Fingers</title>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <!-- Load Handpose -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        #videoElement {
            width: 640px;
            height: 480px;
            margin: 20px auto;
            border: 2px solid #333;
            transform: scaleX(-1);
        }
        .question {
            font-size: 32px;
            margin: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .result {
            font-size: 24px;
            margin: 20px;
            padding: 10px;
        }
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
        }
        .score {
            font-size: 24px;
            font-weight: bold;
            margin: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Math Game with Fingers</h1>
        <div class="score" id="score">Score: 0</div>
        <div class="question" id="questionDiv">Loading...</div>
        <div class="result" id="result">Show your answer with fingers!</div>
        <video id="videoElement" autoplay playsinline></video>
    </div>

    <script>
        let currentAnswer = 0;
        let score = 0;
        const video = document.getElementById('videoElement');
        const result = document.getElementById('result');
        const questionDiv = document.getElementById('questionDiv');
        const scoreDiv = document.getElementById('score');

        // Generate a math question
        function generateQuestion() {
            const num1 = Math.floor(Math.random() * 5) + 1;
            const num2 = Math.floor(Math.random() * 5) + 1;
            currentAnswer = num1 + num2;
            questionDiv.textContent = `What is ${num1} + ${num2}?`;
        }

        // Count extended fingers from landmarks
        function countFingers(predictions) {
            if (!predictions.length) return 0;
            
            const landmarks = predictions[0].landmarks;
            let count = 0;
            
            // Define finger bases (MCP joints)
            const bases = [5, 9, 13, 17];  // Index, Middle, Ring, Pinky
            const tips = [8, 12, 16, 20];  // Corresponding fingertips
            
            // Check each finger
            for (let i = 0; i < bases.length; i++) {
                const base = landmarks[bases[i]];
                const tip = landmarks[tips[i]];
                
                // If fingertip is higher than base, finger is extended
                if (tip[1] < base[1]) {
                    count++;
                }
            }
            
            // Check thumb separately
            const thumbTip = landmarks[4];
            const thumbBase = landmarks[2];
            if (thumbTip[0] < thumbBase[0]) {
                count++;
            }
            
            return count;
        }

        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 640, height: 480 }
            });
            video.srcObject = stream;
            return new Promise(resolve => {
                video.onloadedmetadata = () => {
                    resolve(video);
                };
            });
        }

        async function init() {
            await setupCamera();
            const model = await handpose.load();
            generateQuestion();

            async function detect() {
                const predictions = await model.estimateHands(video);
                if (predictions.length > 0) {
                    const fingerCount = countFingers(predictions);
                    
                    if (fingerCount === currentAnswer) {
                        result.textContent = `Correct! You showed ${fingerCount} fingers!`;
                        result.className = 'result correct';
                        score += 10;
                        scoreDiv.textContent = `Score: ${score}`;
                        setTimeout(generateQuestion, 1000);
                    } else {
                        result.textContent = `You're showing ${fingerCount} fingers. Keep trying!`;
                        result.className = 'result incorrect';
                    }
                }
                requestAnimationFrame(detect);
            }
            
            detect();
        }

        // Start the game
        init();
    </script>
</body>
</html>